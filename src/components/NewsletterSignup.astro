---
// NewsletterSignup component
// 
// Usage:
//   <NewsletterSignup />
//   <NewsletterSignup buttonText="Subscribe" />
//

interface Props {
  buttonText?: string;
}

const { buttonText = 'Subscribe' } = Astro.props;
---

<form class="newsletter-signup" id="newsletter-signup-form">
  <div class="newsletter-name-fields">
    <div class="newsletter-field">
      <label for="newsletter-first-name" class="visually-hidden">First name</label>
      <input
        type="text"
        id="newsletter-first-name"
        name="firstName"
        placeholder="First name"
        required
        autocomplete="given-name"
        aria-describedby="newsletter-message"
      />
    </div>
    <div class="newsletter-field">
      <label for="newsletter-last-name" class="visually-hidden">Last name</label>
      <input
        type="text"
        id="newsletter-last-name"
        name="lastName"
        placeholder="Last name"
        required
        autocomplete="family-name"
        aria-describedby="newsletter-message"
      />
    </div>
  </div>
  <div class="newsletter-field">
    <label for="newsletter-email" class="visually-hidden">Email address</label>
    <input
      type="email"
      id="newsletter-email"
      name="email"
      placeholder="Your email"
      required
      autocomplete="email"
      aria-describedby="newsletter-message"
    />
    <!-- Honeypot field: invisible, not in tab order, not announced by screen readers -->
    <input
      type="text"
      name="company"
      class="honeypot"
      tabindex="-1"
      autocomplete="off"
      aria-hidden="true"
    />
  </div>
  <button type="submit" class="btn btn-secondary" id="newsletter-submit">
    {buttonText}
  </button>
  <p class="form-note">No spam. Unsubscribe anytime.</p>
  <div id="newsletter-message" role="status" aria-live="polite" class="newsletter-message"></div>
</form>

<script>
  const form = document.getElementById('newsletter-signup-form') as HTMLFormElement;
  const firstNameInput = document.getElementById('newsletter-first-name') as HTMLInputElement;
  const lastNameInput = document.getElementById('newsletter-last-name') as HTMLInputElement;
  const emailInput = document.getElementById('newsletter-email') as HTMLInputElement;
  const submitBtn = document.getElementById('newsletter-submit') as HTMLButtonElement;
  const messageDiv = document.getElementById('newsletter-message') as HTMLDivElement;

  if (form && firstNameInput && lastNameInput && emailInput && submitBtn && messageDiv) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear previous messages
      messageDiv.textContent = '';
      messageDiv.className = 'newsletter-message';

      // Disable button and show loading state
      submitBtn.disabled = true;
      const originalButtonText = submitBtn.textContent;
      submitBtn.textContent = 'Submittingâ€¦';

      // Collect form data
      const formData = new FormData(form);
      const firstName = formData.get('firstName')?.toString().trim() || '';
      const lastName = formData.get('lastName')?.toString().trim() || '';
      const email = formData.get('email')?.toString().trim() || '';
      const company = formData.get('company')?.toString().trim() || '';

      try {
        const response = await fetch('/api/newsletter/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            firstName,
            lastName,
            email,
            company,
          }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // Success
          messageDiv.textContent = 'Thanks! Check your email to confirm your subscription.';
          messageDiv.className = 'newsletter-message newsletter-message-success';
          firstNameInput.value = '';
          lastNameInput.value = '';
          emailInput.value = '';
          firstNameInput.focus();
        } else {
          // Error
          const errorMessage = data.error || 'Something went wrong. Please try again later.';
          messageDiv.textContent = errorMessage;
          messageDiv.className = 'newsletter-message newsletter-message-error';
          emailInput.focus();
        }
      } catch (error) {
        // Network error
        messageDiv.textContent = 'Network error. Please check your connection and try again.';
        messageDiv.className = 'newsletter-message newsletter-message-error';
        emailInput.focus();
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = originalButtonText || 'Subscribe';
      }
    });
  }
</script>

<style>
  .newsletter-signup {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .newsletter-name-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .newsletter-field {
    position: relative;
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  .honeypot {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    opacity: 0;
    pointer-events: none;
  }

  .newsletter-message {
    font-size: 0.9rem;
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 4px;
  }

  .newsletter-message-success {
    color: var(--color-accent);
    background: rgba(92, 225, 230, 0.1);
    border: 1px solid rgba(92, 225, 230, 0.3);
  }

  .newsletter-message-error {
    color: var(--color-primary);
    background: rgba(239, 31, 159, 0.1);
    border: 1px solid rgba(239, 31, 159, 0.3);
  }

  .newsletter-signup input:focus {
    outline: none;
  }

  .newsletter-signup button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  @media (max-width: 768px) {
    .newsletter-name-fields {
      grid-template-columns: 1fr;
    }
  }
</style>
